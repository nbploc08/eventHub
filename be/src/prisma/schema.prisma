generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum SeatStatus {
  AVAILABLE
  RESERVED
  SOLD
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

//////////////////////
// MODELS
//////////////////////
model EmailOtp {
  id          String   @id @default(uuid())
  userId      String
  codeHash    String
  expiresAt   DateTime
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("emailOtps")
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String
  tokenHash   String   @unique
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())

  deviceName  String?
  ipAddress   String?
  userAgent   String?

  user User @relation(fields: [userId], references: [id],onDelete: Cascade )

    @@map("refreshTokens")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)

  refreshTokens RefreshToken[]
  emailOtps      EmailOtp[]
  orders       Order[]
  events       Event[]  @relation("OrganizerEvents")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

model Event {
  id          String      @id @default(uuid())
  organizerId String
  title       String
  description String?
  venue       String
  startTime   DateTime
  endTime     DateTime
  hasSeat     Boolean
  status      EventStatus @default(DRAFT)

  organizer   User        @relation("OrganizerEvents", fields: [organizerId], references: [id])
  ticketTypes TicketType[]
  seats       Seat[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("events")
}

model TicketType {
  id         String   @id @default(uuid())
  eventId    String
  name       String
  price      Decimal  @db.Decimal(12, 2)
  zone       String?
  quantity   Int?

  event      Event       @relation(fields: [eventId], references: [id])
  tickets    Ticket[]
  orderItems OrderItem[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ticket_types")
}

model Seat {
  id         String     @id @default(uuid())
  eventId    String
  zone       String
  rowLabel   String
  seatNumber String
  status     SeatStatus @default(AVAILABLE)
  expireAt   DateTime?

  event      Event      @relation(fields: [eventId], references: [id])
  ticket     Ticket?

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([eventId, zone, rowLabel, seatNumber])
  @@map("seats")
}

model Order {
  id          String      @id @default(uuid())
  userId      String
  totalAmount Decimal     @db.Decimal(12, 2)
  status      OrderStatus @default(PENDING)

  user        User        @relation(fields: [userId], references: [id])
  items       OrderItem[]
  tickets     Ticket[]
  payment     Payment?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("orders")
}

model OrderItem {
  id           String   @id @default(uuid())
  orderId      String
  ticketTypeId String
  ticketId     String?  @unique   // ✅ thêm dòng này
  price        Decimal  @db.Decimal(12, 2)

  order        Order      @relation(fields: [orderId], references: [id])
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])
  ticket       Ticket?    @relation(fields: [ticketId], references: [id])

  createdAt    DateTime   @default(now())

  @@map("order_items")
}


model Ticket {
  id           String       @id @default(uuid())
  orderId      String
  ticketTypeId String
  seatId       String?      @unique
  qrCode       String       @unique
  status       TicketStatus @default(VALID)

  order        Order        @relation(fields: [orderId], references: [id])
  ticketType   TicketType   @relation(fields: [ticketTypeId], references: [id])
  seat         Seat?        @relation(fields: [seatId], references: [id])
  orderItem    OrderItem?

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("tickets")
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String        @unique
  provider  String
  status    PaymentStatus @default(PENDING)
  payload   Json?

  order     Order         @relation(fields: [orderId], references: [id])

  createdAt DateTime      @default(now())

  @@map("payments")
}
